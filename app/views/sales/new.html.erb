<% content_for :page_title, "Record New Sale" %>

<div class="p-4 max-w-4xl mx-auto space-y-4">
  <!-- Header Section -->
  <div class="bg-white/80 backdrop-blur-sm rounded-xl shadow-lg border border-white/20 overflow-hidden">
    <div class="bg-gradient-to-r from-green-600 to-emerald-600 px-6 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <%= link_to sales_path, class: "flex items-center text-white/80 hover:text-white mr-4 no-underline" do %>
            <i data-feather="arrow-left" class="h-4 w-4 mr-2"></i>
            Back to Sales
          <% end %>
          <h1 class="text-xl font-bold text-white">
            Record New Sale
          </h1>
        </div>
      </div>
    </div>
  </div>

  <!-- Sale Form -->
  <div class="bg-white/80 backdrop-blur-sm rounded-xl shadow-lg border border-white/20 overflow-hidden">
    <div class="bg-gradient-to-r from-gray-600 to-gray-700 px-6 py-3">
      <h3 class="text-lg font-semibold text-white">Sale Details</h3>
    </div>
    
    <div class="p-6">
      <%= form_with model: @sale, local: true, class: "space-y-6" do |f| %>
        <!-- Error Messages -->
        <% if @sale.errors.any? %>
          <div class="bg-red-50 border border-red-200 rounded-lg p-4">
            <div class="flex">
              <div class="flex-shrink-0">
                <i data-feather="alert-circle" class="w-4 h-4 text-red-400"></i>
              </div>
              <div class="ml-3">
                <h3 class="text-sm font-medium text-red-800">
                  Please fix the following errors:
                </h3>
                <div class="mt-2 text-sm text-red-700">
                  <ul class="list-disc list-inside space-y-1">
                    <% @sale.errors.full_messages.each do |message| %>
                      <li><%= message %></li>
                    <% end %>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        <% end %>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Left Column - Product Selection -->
          <div class="space-y-4">
            <!-- Product Selection -->
            <div>
              <%= f.label :product_id, "Select Product *", class: "block text-sm font-medium text-gray-700 mb-2" %>
              <%= f.collection_select :product_id, @products, :id, :name, 
                  { prompt: "Choose a product to sell..." }, 
                  { 
                    class: "block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500",
                    required: true,
                    onchange: "updateProductInfo()"
                  } %>
            </div>

            <!-- Product Info Display -->
            <div id="product-info" class="hidden bg-gray-50 rounded-lg p-4 border">
              <div class="flex items-center space-x-4">
                <div id="product-image" class="w-16 h-16 bg-gray-200 rounded-lg flex items-center justify-center">
                  <i data-feather="package" class="w-8 h-8 text-gray-400"></i>
                </div>
                <div class="flex-1">
                  <h4 id="product-name" class="font-semibold text-gray-900"></h4>
                  <p class="text-sm text-gray-600">
                    Available: <span id="product-stock" class="font-medium"></span> packs
                  </p>
                  <p class="text-sm text-gray-600">
                    Selling Price: <span id="product-price" class="font-medium text-green-600"></span>
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Right Column - Sale Details -->
          <div class="space-y-4">
            <!-- Quantity -->
            <div>
              <%= f.label :quantity, "Quantity (Packs) *", class: "block text-sm font-medium text-gray-700 mb-2" %>
              <%= f.number_field :quantity,
                  min: 1,
                  class: "block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500",
                  placeholder: "1",
                  required: true,
                  onchange: "calculateTotal()" %>
              <p class="mt-1 text-xs text-gray-500">How many packs are you selling?</p>
            </div>

            <!-- Selling Price -->
            <div>
              <%= f.label :unit_price, "Selling Price per Pack *", class: "block text-sm font-medium text-gray-700 mb-2" %>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <span class="text-gray-500 text-sm">PKR</span>
                </div>
                <%= f.number_field :unit_price,
                    step: 0.01,
                    min: 0,
                    class: "block w-full pl-12 pr-3 py-2 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500",
                    placeholder: "0.00",
                    required: true,
                    onchange: "calculateTotal()" %>
              </div>
              <p class="mt-1 text-xs text-gray-500">Price you're selling each pack for</p>
            </div>

            <!-- Total Amount Display -->
            <div class="bg-green-50 rounded-lg p-4 border border-green-200">
              <div class="flex justify-between items-center">
                <span class="text-sm font-medium text-green-700">Total Sale Amount:</span>
                <span id="total-amount" class="text-lg font-bold text-green-600">PKR 0.00</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="flex flex-col sm:flex-row sm:justify-end sm:gap-3 pt-6 border-t border-gray-200">
          <%= link_to sales_path,
              class: "w-full sm:w-auto inline-flex justify-center items-center px-4 py-2 border border-gray-300 rounded-lg shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors mb-3 sm:mb-0 no-underline" do %>
            Cancel
          <% end %>
          
          <%= f.submit "Record Sale",
              class: "w-full sm:w-auto inline-flex justify-center items-center px-6 py-2 border border-transparent rounded-lg shadow-sm bg-green-600 text-sm font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  // Product data for quick access
  const products = {
    <% @products.each do |product| %>
      <%= product.id %>: {
        name: "<%= product.name %>",
        stock: <%= product.quantity %>,
        price: <%= product.selling_price %>,
        imageUrl: "<%= product.image_url %>"
      },
    <% end %>
  };

  function updateProductInfo() {
    const productId = document.getElementById('sale_product_id').value;
    const productInfo = document.getElementById('product-info');
    
    if (productId && products[productId]) {
      const product = products[productId];
      
      // Update product info display
      document.getElementById('product-name').textContent = product.name;
      document.getElementById('product-stock').textContent = product.stock;
      document.getElementById('product-price').textContent = 'PKR ' + product.price.toLocaleString();
      
      // Update product image
      const imageContainer = document.getElementById('product-image');
      if (product.imageUrl && product.imageUrl.trim() !== '') {
        imageContainer.innerHTML = `<img src="${product.imageUrl}" alt="${product.name}" class="w-full h-full object-cover rounded-lg">`;
      } else {
        imageContainer.innerHTML = '<i data-feather="package" class="w-8 h-8 text-gray-400"></i>';
        feather.replace();
      }
      
      // Set default selling price
      document.getElementById('sale_unit_price').value = product.price;
      
      // Update quantity max
      document.getElementById('sale_quantity').max = product.stock;
      
      // Show product info
      productInfo.classList.remove('hidden');
      
      // Calculate total
      calculateTotal();
    } else {
      productInfo.classList.add('hidden');
    }
  }

  function calculateTotal() {
    const quantity = parseFloat(document.getElementById('sale_quantity').value) || 0;
    const unitPrice = parseFloat(document.getElementById('sale_unit_price').value) || 0;
    const totalAmount = quantity * unitPrice;
    
    document.getElementById('total-amount').textContent = 'PKR ' + totalAmount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
  }

  // Initialize feather icons
  feather.replace();
</script>
